<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»º COC è§’è‰²å¡</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh; padding: 20px; color: #fff;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px; padding: 25px; margin-bottom: 20px;
        }
        .card h2 { margin-bottom: 15px; color: #4fc3f7; font-size: 1.2rem; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; }
        input, textarea {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem;
        }
        input:focus, textarea:focus { outline: 2px solid #4fc3f7; }
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .attr-item { text-align: center; }
        .attr-item label { font-weight: bold; color: #fff; }
        .attr-item input { text-align: center; }
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            background: linear-gradient(135deg, #4fc3f7, #2196f3);
            color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .success { background: #4caf50; padding: 20px; border-radius: 10px; text-align: center; }
        .error { background: #f44336; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        textarea { min-height: 120px; resize: vertical; }
        .hint { font-size: 0.85rem; color: #888; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ² åˆ›å»º COC è§’è‰²å¡</h1>
        
        <form id="charForm">
            <input type="hidden" name="token" value="{{ token }}">

            <div class="card">
                <h2>ğŸ“ åŸºæœ¬ä¿¡æ¯</h2>
                <div class="form-group">
                    <label>è§’è‰²åç§° *</label>
                    <input type="text" name="name" required placeholder="è¾“å…¥è§’è‰²åç§°">
                </div>
            </div>

            <div class="card">
                <h2>ğŸ’ª å±æ€§å€¼</h2>
                <div class="attr-grid">
                    <div class="attr-item">
                        <label>STR åŠ›é‡</label>
                        <input type="number" name="str_val" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>CON ä½“è´¨</label>
                        <input type="number" name="con" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>SIZ ä½“å‹</label>
                        <input type="number" name="siz" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>DEX æ•æ·</label>
                        <input type="number" name="dex" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>APP å¤–è²Œ</label>
                        <input type="number" name="app" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>INT æ™ºåŠ›</label>
                        <input type="number" name="int_val" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>POW æ„å¿—</label>
                        <input type="number" name="pow_val" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>EDU æ•™è‚²</label>
                        <input type="number" name="edu" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>LUK å¹¸è¿</label>
                        <input type="number" name="luk" value="50" min="1" max="99">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>â¤ï¸ æ´¾ç”Ÿå±æ€§</h2>
                <div class="attr-grid">
                    <div class="attr-item">
                        <label>HP ç”Ÿå‘½</label>
                        <input type="number" name="hp" value="10" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>MP é­”æ³•</label>
                        <input type="number" name="mp" value="10" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label>SAN ç†æ™º</label>
                        <input type="number" name="san" value="50" min="0" max="99">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ¯ æŠ€èƒ½</h2>
                <div class="form-group">
                    <label>æŠ€èƒ½åˆ—è¡¨</label>
                    <textarea name="skills" placeholder="æ¯è¡Œä¸€ä¸ªæŠ€èƒ½ï¼Œæ ¼å¼ï¼šæŠ€èƒ½å:æ•°å€¼
ä¾‹å¦‚ï¼š
ä¾¦æŸ¥:60
å›¾ä¹¦é¦†:50
è†å¬:40
å¿ƒç†å­¦:35"></textarea>
                    <p class="hint">æ¯è¡Œä¸€ä¸ªæŠ€èƒ½ï¼Œæ ¼å¼ä¸ºã€ŒæŠ€èƒ½å:æ•°å€¼ã€</p>
                </div>
            </div>

            <button type="submit" class="btn" id="submitBtn">âœ¨ åˆ›å»ºè§’è‰²å¡</button>
            <button type="button" class="btn" id="exportBtn" style="margin-top:10px; background: linear-gradient(135deg, #9c27b0, #673ab7);">ğŸ“‹ ç”Ÿæˆå¯¼å…¥æŒ‡ä»¤</button>
        </form>

        <div id="result" style="display:none;"></div>
        <div id="exportResult" style="display:none;" class="card">
            <h2>ğŸ“‹ å¯¼å…¥æŒ‡ä»¤</h2>
            <p class="hint">å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ° KOOK å‘é€å³å¯å¯¼å…¥è§’è‰²å¡ï¼š</p>
            <textarea id="exportText" readonly style="margin-top:10px; min-height:80px;"></textarea>
            <button type="button" class="btn" id="copyBtn" style="margin-top:10px;">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        </div>
    </div>

    <script>
        function getFormData() {
            const form = document.getElementById('charForm');
            const data = new FormData(form);
            const name = data.get('name');
            const skills = {};
            const skillsText = data.get('skills').trim();
            if (skillsText) {
                skillsText.split('\n').forEach(line => {
                    line = line.replace('ï¼š', ':');
                    if (line.includes(':')) {
                        const [k, v] = line.split(':');
                        const val = parseInt(v.trim());
                        if (!isNaN(val)) skills[k.trim()] = val;
                    }
                });
            }
            return {
                name: name,
                attributes: {
                    STR: parseInt(data.get('str_val')),
                    CON: parseInt(data.get('con')),
                    SIZ: parseInt(data.get('siz')),
                    DEX: parseInt(data.get('dex')),
                    APP: parseInt(data.get('app')),
                    INT: parseInt(data.get('int_val')),
                    POW: parseInt(data.get('pow_val')),
                    EDU: parseInt(data.get('edu')),
                    LUK: parseInt(data.get('luk'))
                },
                skills: skills,
                hp: parseInt(data.get('hp')),
                mp: parseInt(data.get('mp')),
                san: parseInt(data.get('san'))
            };
        }
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            const charData = getFormData();
            if (!charData.name) {
                alert('è¯·å…ˆå¡«å†™è§’è‰²åç§°');
                return;
            }
            const json = JSON.stringify(charData);
            const cmd = '.pc new ' + json;
            document.getElementById('exportText').value = cmd;
            document.getElementById('exportResult').style.display = 'block';
        });
        
        document.getElementById('copyBtn').addEventListener('click', () => {
            const text = document.getElementById('exportText');
            text.select();
            document.execCommand('copy');
            document.getElementById('copyBtn').textContent = 'âœ… å·²å¤åˆ¶';
            setTimeout(() => {
                document.getElementById('copyBtn').textContent = 'å¤åˆ¶åˆ°å‰ªè´´æ¿';
            }, 2000);
        });

        document.getElementById('charForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'åˆ›å»ºä¸­...';
            
            const formData = new FormData(e.target);
            
            try {
                const resp = await fetch('/api/character/create', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                
                if (data.success) {
                    document.getElementById('charForm').style.display = 'none';
                    document.getElementById('result').innerHTML = 
                        '<div class="success"><h2>âœ… ' + data.message + '</h2><p>è¿”å› KOOK ä½¿ç”¨ .pc show æŸ¥çœ‹è§’è‰²å¡</p></div>';
                    document.getElementById('result').style.display = 'block';
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + (data.detail || data.message));
                    btn.disabled = false;
                    btn.textContent = 'âœ¨ åˆ›å»ºè§’è‰²å¡';
                }
            } catch (err) {
                alert('è¯·æ±‚å¤±è´¥: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'âœ¨ åˆ›å»ºè§’è‰²å¡';
            }
        });
    </script>
</body>
</html>
