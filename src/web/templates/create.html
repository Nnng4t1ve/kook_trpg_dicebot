<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»º COC7 è§’è‰²å¡</title>
    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/create.css">
    <link rel="stylesheet" href="/static/css/create-components.css">
</head>

<body>
    <div class="container">
        <h1>ğŸ² åˆ›å»º COC7 è§’è‰²å¡</h1>
        <form id="charForm">
            <input type="hidden" name="token" value="{{ token }}">

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="card">
                <h2>ğŸ“ åŸºæœ¬ä¿¡æ¯</h2>
                <label>è§’è‰²åç§° *</label>
                <input type="text" name="name" id="charName" required placeholder="è¾“å…¥è§’è‰²åç§°">
                <div class="basic-info-row">
                    <div class="basic-info-item">
                        <label>å¹´é¾„</label>
                        <input type="text" name="age" id="charAge" placeholder="__">
                    </div>
                    <div class="basic-info-item">
                        <label>æ€§åˆ«</label>
                        <input type="text" name="gender" id="charGender" placeholder="__">
                    </div>
                    <div class="basic-info-item">
                        <label>å›½ç±</label>
                        <input type="text" name="nationality" id="charNationality" placeholder="__">
                    </div>
                </div>
                <!-- èŒä¸šæŸ¥è¯¢ -->
                <div class="occupation-query-section">
                    <label>èŒä¸šåºå· (è¾“å…¥åºå·æŸ¥çœ‹èŒä¸šä¿¡æ¯ï¼Œå›è½¦æŸ¥è¯¢)</label>
                    <div class="occupation-query-row">
                        <input type="number" id="occupationId" placeholder="è¾“å…¥èŒä¸šåºå·" min="0">
                        <button type="button" class="btn-inline" id="queryOccupationBtn"
                            onclick="OccupationManager.queryOccupation()">ğŸ”</button>
                    </div>
                    <div id="occupationOutput" class="occupation-output">
                        <p class="hint">è¾“å…¥èŒä¸šåºå·åç‚¹å‡»æŸ¥è¯¢</p>
                    </div>
                </div>
                <!-- èŒä¸šåˆ—è¡¨æŒ‰é’® -->
                <button type="button" class="btn btn-card-action"
                    onclick="window.open('/static/pages/èŒä¸šåˆ—è¡¨.html', '_blank')">ğŸ“‹ æŸ¥çœ‹èŒä¸šåˆ—è¡¨</button>
            </div>

            <!-- å±æ€§å€¼ -->
            <div class="card">
                <h2>ğŸ’ª å±æ€§å€¼
                    <button type="button" class="btn-random" id="randomAllBtn">ğŸ² éšæœºå…¨éƒ¨</button>
                    <button type="button" class="btn-random btn-random-multi" id="randomMultiBtn">ğŸ² å¤©å‘½Roll 5</button>
                </h2>

                <!-- æ‰¹é‡éšæœºé¢„è§ˆé¢æ¿ -->
                <div id="randomPreviewPanel" class="random-preview-panel" style="display:none;">
                    <div class="preview-header">
                        <span>é€‰æ‹©ä¸€ç»„å±æ€§å¡«å…¥</span>
                        <div class="preview-controls">
                            <button type="button" class="preview-view-btn active" data-view="card">å¡ç‰‡</button>
                            <button type="button" class="preview-view-btn" data-view="table">è¡¨æ ¼</button>
                            <button type="button" class="preview-close-btn" id="closePreviewBtn">âœ•</button>
                        </div>
                    </div>
                    <div id="previewContent" class="preview-content preview-card-view"></div>
                </div>
                <p class="hint" style="margin-bottom:8px;">å‹¾é€‰å±æ€§ç”¨äºè®¡ç®—èŒä¸šç‚¹æ•°ï¼ˆæœ€å¤š2ä¸ªï¼‰</p>
                <div class="attr-grid">
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="str">STR åŠ›é‡</span> <span class="formula">3D6Ã—5</span></label>
                        <input type="number" id="str" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="con">CON ä½“è´¨</span> <span class="formula">3D6Ã—5</span></label>
                        <input type="number" id="con" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="siz">SIZ ä½“å‹</span> <span class="formula">(2D6+6)Ã—5</span></label>
                        <input type="number" id="siz" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="dex">DEX æ•æ·</span> <span class="formula">3D6Ã—5</span></label>
                        <input type="number" id="dex" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="app">APP å¤–è²Œ</span> <span class="formula">3D6Ã—5</span></label>
                        <input type="number" id="app" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="int">INT æ™ºåŠ›</span> <span class="formula">(2D6+6)Ã—5</span></label>
                        <input type="number" id="int" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="pow">POW æ„å¿—</span> <span class="formula">3D6Ã—5</span></label>
                        <input type="number" id="pow" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><input type="checkbox" class="attr-checkbox"
                                    data-attr="edu">EDU æ•™è‚²</span> <span class="formula">(2D6+6)Ã—5</span></label>
                        <input type="number" id="edu" value="50" min="1" max="99">
                    </div>
                    <div class="attr-item">
                        <label><span class="attr-label-row"><span style="width:16px;display:inline-block;"></span>LUK
                                å¹¸è¿</span> <span class="formula">3D6Ã—5</span></label>
                        <input type="number" id="luk" value="50" min="1" max="99">
                    </div>
                </div>
                <div class="attr-total">
                    <span>æ€»è®¡(ä¸å«å¹¸è¿): <strong id="totalNoLuk">400</strong></span>
                    <span>æ€»è®¡(å«å¹¸è¿): <strong id="totalWithLuk">450</strong></span>
                </div>
                <div class="points-display">
                    <div class="points-box">
                        <div class="label">èŒä¸šç‚¹æ•°</div>
                        <div class="value job-points" id="jobPointsRemain">0</div>
                        <div class="points-formula" id="jobFormula">æœªé€‰æ‹©å±æ€§</div>
                    </div>
                    <div class="points-box">
                        <div class="label">å…´è¶£ç‚¹æ•°</div>
                        <div class="value hobby-points" id="hobbyPointsRemain">100</div>
                        <div class="points-formula">INT Ã— 2</div>
                    </div>
                </div>
            </div>

            <!-- æ´¾ç”Ÿå±æ€§ -->
            <div class="card">
                <h2>â¤ï¸ æ´¾ç”Ÿå±æ€§ (è‡ªåŠ¨è®¡ç®—)</h2>
                <div class="derived-grid">
                    <div class="derived-item">
                        <div class="label">HP</div>
                        <div class="value" id="hp">10</div>
                    </div>
                    <div class="derived-item">
                        <div class="label">MP</div>
                        <div class="value" id="mp">10</div>
                    </div>
                    <div class="derived-item">
                        <div class="label">SAN</div>
                        <div class="value" id="san">50</div>
                    </div>
                    <div class="derived-item">
                        <div class="label">MOV</div>
                        <div class="value" id="mov">8</div>
                    </div>
                    <div class="derived-item">
                        <div class="label">ä½“æ ¼</div>
                        <div class="value" id="build">0</div>
                    </div>
                    <div class="derived-item">
                        <div class="label">ä¼¤å®³åŠ å€¼</div>
                        <div class="value" id="db">0</div>
                    </div>
                </div>
            </div>

            <!-- æŠ€èƒ½ -->
            <div class="card">
                <h2>ğŸ¯ æŠ€èƒ½ <span class="hint">(åŸºç¡€+èŒä¸š+å…´è¶£=æˆåŠŸç‡ï¼ŒåŒå‡»æŠ€èƒ½è¡Œè®¾ä¸ºæœ¬èŒ)</span></h2>
                <div id="skillLimitHint" class="skill-limit-hint" style="display:none;"></div>
                <div id="skillsContainer">
                    <p class="hint">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <!-- æ­¦å™¨æ  -->
            <div class="card">
                <h2>âš”ï¸ æ­¦å™¨</h2>
                <table class="weapon-table">
                    <thead>
                        <tr>
                            <th>æ­¦å™¨</th>
                            <th>æŠ€èƒ½</th>
                            <th>ä¼¤å®³</th>
                        </tr>
                    </thead>
                    <tbody id="weaponBody">
                        <tr>
                            <td><input type="text" name="weapon_name_1" placeholder="æ­¦å™¨åç§°"></td>
                            <td><input type="text" name="weapon_skill_1" placeholder="æŠ€èƒ½"></td>
                            <td><input type="text" name="weapon_damage_1" placeholder="ä¼¤å®³"></td>
                        </tr>
                        <tr>
                            <td><input type="text" name="weapon_name_2" placeholder="æ­¦å™¨åç§°"></td>
                            <td><input type="text" name="weapon_skill_2" placeholder="æŠ€èƒ½"></td>
                            <td><input type="text" name="weapon_damage_2" placeholder="ä¼¤å®³"></td>
                        </tr>
                        <tr>
                            <td><input type="text" name="weapon_name_3" placeholder="æ­¦å™¨åç§°"></td>
                            <td><input type="text" name="weapon_skill_3" placeholder="æŠ€èƒ½"></td>
                            <td><input type="text" name="weapon_damage_3" placeholder="ä¼¤å®³"></td>
                        </tr>
                    </tbody>
                </table>
                <!-- æ­¦å™¨åˆ—è¡¨æŒ‰é’® -->
                <button type="button" class="btn btn-card-action"
                    onclick="window.open('/static/pages/æ­¦å™¨åˆ—è¡¨.html', '_blank')">âš”ï¸ æŸ¥çœ‹æ­¦å™¨åˆ—è¡¨</button>
            </div>

            <!-- ç‰©å“æ  -->
            <div class="card">
                <h2>ğŸ’ éšèº«ç‰©å“ï¼ˆä½¿ç”¨å³ä¾§æ ä½éœ€è¦èƒŒåŒ…ï¼‰</h2>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">éƒ¨ä½</th>
                            <th>ç‰©å“åç§°</th>
                            <th>èƒŒåŒ…æ ¼â†“</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>

            <!-- èƒŒæ™¯æ•…äº‹ -->
            <div class="card">
                <h2>ğŸ“– èƒŒæ™¯æ•…äº‹</h2>
                <p class="hint" style="margin-bottom:12px;">è¯·åŠ¡å¿…åœ¨æ­¤å¡«å†™èƒŒæ™¯æ•…äº‹ï¼ä½¿ç”¨ Alt+Enter æ¢è¡Œ</p>
                <table class="backstory-table">
                    <thead>
                        <tr>
                            <th style="width:100px;">é¡¹ç›®</th>
                            <th>å†…å®¹</th>
                            <th style="width:50px;">å…³é”®è¿æ¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="backstory-row">
                            <td class="backstory-label">å½¢è±¡æè¿°</td>
                            <td><textarea class="backstory-input" name="appearance"
                                    placeholder="æè¿°è§’è‰²çš„å¤–è²Œç‰¹å¾..."></textarea></td>
                            <td><input type="checkbox" class="key-connection" name="appearance_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">æ€æƒ³ä¸ä¿¡å¿µ</td>
                            <td><textarea class="backstory-input" name="ideology" placeholder="è§’è‰²çš„ä¿¡ä»°ã€ä»·å€¼è§‚..."></textarea>
                            </td>
                            <td><input type="checkbox" class="key-connection" name="ideology_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">é‡è¦ä¹‹äºº</td>
                            <td><textarea class="backstory-input" name="significant_people"
                                    placeholder="å¯¹è§’è‰²é‡è¦çš„äºº..."></textarea></td>
                            <td><input type="checkbox" class="key-connection" name="significant_people_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">æ„ä¹‰éå‡¡ä¹‹åœ°</td>
                            <td><textarea class="backstory-input" name="meaningful_locations"
                                    placeholder="å¯¹è§’è‰²æœ‰ç‰¹æ®Šæ„ä¹‰çš„åœ°ç‚¹..."></textarea></td>
                            <td><input type="checkbox" class="key-connection" name="meaningful_locations_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">å®è´µä¹‹ç‰©</td>
                            <td><textarea class="backstory-input" name="treasured_possessions"
                                    placeholder="è§’è‰²çè§†çš„ç‰©å“..."></textarea></td>
                            <td><input type="checkbox" class="key-connection" name="treasured_possessions_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">ç‰¹è´¨</td>
                            <td><textarea class="backstory-input" name="traits" placeholder="è§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹..."></textarea>
                            </td>
                            <td><input type="checkbox" class="key-connection" name="traits_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">ä¼¤å£å’Œä¼¤ç–¤</td>
                            <td><textarea class="backstory-input" name="injuries" placeholder="è§’è‰²èº«ä¸Šçš„ä¼¤ç—•..."></textarea>
                            </td>
                            <td><input type="checkbox" class="key-connection" name="injuries_key"></td>
                        </tr>
                        <tr class="backstory-row">
                            <td class="backstory-label">ææƒ§ç—‡å’Œèºç‹‚ç—‡</td>
                            <td><textarea class="backstory-input" name="phobias" placeholder="è§’è‰²çš„ææƒ§æˆ–ç‹‚èº..."></textarea>
                            </td>
                            <td><input type="checkbox" class="key-connection" name="phobias_key"></td>
                        </tr>
                    </tbody>
                </table>
                <!-- è¯¦ç»†ç»å† -->
                <div class="detailed-story-section">
                    <h3>ğŸ“ è¯¦ç»†ç»å†</h3>
                    <textarea class="detailed-story-input" name="detailed_story"
                        placeholder="åœ¨æ­¤è¯¦ç»†æè¿°è§’è‰²çš„èƒŒæ™¯æ•…äº‹ã€æˆé•¿ç»å†ã€é‡è¦äº‹ä»¶ç­‰...&#10;&#10;å¯ä»¥åŒ…æ‹¬ï¼š&#10;- è§’è‰²çš„å‡ºç”Ÿå’Œç«¥å¹´&#10;- é‡è¦çš„äººç”Ÿè½¬æŠ˜ç‚¹&#10;- å¦‚ä½•è·å¾—ç°æœ‰æŠ€èƒ½&#10;- ä¸é‡è¦ä¹‹äººçš„å…³ç³»&#10;- æ¥åˆ°è°ƒæŸ¥åœ°ç‚¹çš„åŸå› &#10;..."></textarea>
                </div>
            </div>

            <button type="submit" class="btn" id="submitBtn" disabled>âœ¨ åˆ›å»ºè§’è‰²å¡ (éœ€å…ˆå®¡æ ¸é€šè¿‡)</button>
            <button type="button" class="btn btn-secondary" id="exportBtn">ğŸ“‹ è§’è‰²å¡å®¡æ ¸</button>
        </form>

        <div id="result" style="display:none;"></div>
        <div id="exportResult" style="display:none;" class="card">
            <h2>ğŸ“‹ å®¡æ ¸æŒ‡ä»¤</h2>
            <p class="hint" style="margin-bottom:8px;">åœ¨ KOOK ä¸­å‘é€ä»¥ä¸‹æŒ‡ä»¤å‘èµ·å®¡æ ¸ï¼ŒKP å®¡æ ¸é€šè¿‡åå³å¯åˆ›å»ºè§’è‰²å¡</p>
            <textarea id="exportText" readonly
                style="width:100%;min-height:60px;margin-top:8px;background:rgba(0,0,0,0.3);color:#fff;border:none;border-radius:6px;padding:8px;"></textarea>
            <button type="button" class="btn btn-secondary" id="copyBtn" style="margin-top:8px;">å¤åˆ¶</button>
        </div>
    </div>

    <!-- æ³¨å…¥æ¨¡æ¿å˜é‡ -->
    <script>
        const APP_TOKEN = '{{ token }}';
        const APP_USER_ID = '{{ user_id }}';
        const SKILL_LIMIT = {{ skill_limit if skill_limit else 'null' }};
        const OCC_LIMIT = {{ occ_limit if occ_limit else 'null' }};
        const NON_OCC_LIMIT = {{ non_occ_limit if non_occ_limit else 'null' }};
    </script>

    <!-- JavaScript æ¨¡å— -->
    <script src="/static/js/create-config.js"></script>
    <script src="/static/js/create-utils.js"></script>
    <script src="/static/js/create-points.js"></script>
    <script src="/static/js/create-skills.js"></script>
    <script src="/static/js/create-attributes.js"></script>
    <script src="/static/js/create-form.js"></script>
    <script src="/static/js/create-review.js"></script>
    <script src="/static/js/create-occupation.js"></script>
    <script src="/static/js/create-main.js"></script>

    <!-- èŒä¸šæŸ¥è¯¢å’Œæœ¬èŒæŠ€èƒ½ç»‘å®š -->
    <script>
        (function () {
            // å›è½¦æŸ¥è¯¢
            document.addEventListener('keydown', function (e) {
                if (e.target.id === 'occupationId' && e.key === 'Enter') {
                    e.preventDefault();
                    if (typeof OccupationManager !== 'undefined') {
                        OccupationManager.queryOccupation();
                    }
                }
            });

            // åŒå‡»è®¾ç½®æœ¬èŒæŠ€èƒ½ - ä½¿ç”¨documentçº§åˆ«äº‹ä»¶å§”æ‰˜
            document.addEventListener('dblclick', function (e) {
                // å¿½ç•¥è¾“å…¥æ¡†
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                // æŸ¥æ‰¾æœ€è¿‘çš„skill-row
                var row = e.target.closest('.skill-row');
                if (row) {
                    e.preventDefault();

                    var skillName = row.dataset.skill;
                    var nameCell = row.querySelector('.skill-name');

                    if (!nameCell) return;

                    if (row.classList.contains('occupation-skill')) {
                        // ç§»é™¤æœ¬èŒæ ‡è®°
                        row.classList.remove('occupation-skill');
                        var marker = nameCell.querySelector('.occ-marker');
                        if (marker) marker.remove();
                    } else {
                        // æ·»åŠ æœ¬èŒæ ‡è®°
                        row.classList.add('occupation-skill');
                        if (!nameCell.querySelector('.occ-marker')) {
                            var marker = document.createElement('span');
                            marker.className = 'occ-marker';
                            marker.textContent = 'â˜…';
                            nameCell.insertBefore(marker, nameCell.firstChild);
                        }
                    }
                }
            });
        })();
    </script>
</body>

</html>